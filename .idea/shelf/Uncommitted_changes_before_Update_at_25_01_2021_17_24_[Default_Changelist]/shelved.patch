Index: app/src/main/java/com/example/walktoshop/User/UserView.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.walktoshop.User;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport androidx.core.app.ActivityCompat;\r\n\r\nimport android.Manifest;\r\nimport android.app.ActivityManager;\r\nimport android.app.AlertDialog;\r\nimport android.app.NotificationChannel;\r\nimport android.app.NotificationManager;\r\nimport android.content.Context;\r\nimport android.content.DialogInterface;\r\nimport android.content.Intent;\r\nimport android.content.pm.PackageManager;\r\nimport android.location.Address;\r\nimport android.location.Geocoder;\r\nimport android.location.Location;\r\nimport android.location.LocationListener;\r\nimport android.location.LocationManager;\r\nimport android.os.Build;\r\nimport android.os.Bundle;\r\nimport android.provider.Settings;\r\nimport android.util.Log;\r\nimport android.view.Gravity;\r\nimport android.view.Menu;\r\nimport android.view.MenuItem;\r\nimport android.view.View;\r\nimport android.widget.AdapterView;\r\nimport android.widget.ImageButton;\r\nimport android.widget.LinearLayout;\r\nimport android.widget.ListView;\r\nimport android.widget.TextView;\r\nimport android.widget.Toast;\r\n\r\n\r\nimport com.example.walktoshop.Login_SignUp.LogIn;\r\nimport com.example.walktoshop.R;\r\n\r\nimport com.example.walktoshop.Seller.Discount;\r\nimport com.example.walktoshop.Seller.SellerViewAdapter;\r\nimport com.google.android.gms.tasks.OnCompleteListener;\r\nimport com.google.android.gms.tasks.Task;\r\nimport com.google.android.material.bottomnavigation.BottomNavigationView;\r\nimport com.google.firebase.auth.FirebaseAuth;\r\nimport com.google.firebase.firestore.DocumentSnapshot;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\n\r\nimport java.io.IOException;\r\nimport java.util.ArrayList;\r\nimport java.util.Iterator;\r\nimport java.util.List;\r\n\r\n\r\npublic class UserView extends AppCompatActivity {\r\n    LocationManager service;\r\n    LocationListener locationListener;\r\n    FirebaseFirestore db =FirebaseFirestore.getInstance();\r\n    private TextView alert;\r\n    private ListView homeListview;\r\n    double longitude;\r\n    double latitude;\r\n    String city;\r\n    private static final String CHANNEL_ID=\"StepCounter_notification_channel\";\r\n    private String userUID=null;\r\n    private ArrayList<Discount> myDiscounts= new ArrayList<>();\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        setContentView(R.layout.activity_user_view);\r\n\r\n        alert=findViewById(R.id.alert);\r\n        alert.setVisibility(View.GONE);\r\n        homeListview= findViewById(R.id.homeListView);\r\n        //setting del channel per quando partirà il service\r\n        createNotificationChannel();\r\n        BottomNavigationView bottomNavigationView = (BottomNavigationView) findViewById(R.id.bottom_navigation);\r\n        bottomNavigationView.setOnNavigationItemSelectedListener(new BottomNavigationView.OnNavigationItemSelectedListener() {\r\n            @Override\r\n            public boolean onNavigationItemSelected(@NonNull MenuItem item) {\r\n                switch (item.getItemId()) {\r\n                    case R.id.action_map:\r\n                        askGPSpermission();\r\n                        break;\r\n                    case R.id.action_statistics:\r\n                        break;\r\n                    case R.id.action_notification:\r\n                        break;\r\n                }\r\n                return true;\r\n            }\r\n        });\r\n        Intent intent =getIntent();\r\n        if(intent.hasExtra(\"UID\")){\r\n            this.userUID = intent.getStringExtra(\"UID\");\r\n        }\r\n    }\r\n\r\n    @Override\r\n    protected void onStart() {\r\n        super.onStart();\r\n        getUserDiscounts();\r\n    }\r\n\r\n    private void getUserDiscounts(){\r\n        db.collection(\"utente\").document(userUID).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {\r\n            @Override\r\n            public void onComplete(@NonNull Task<DocumentSnapshot> task) {\r\n                if(task.isSuccessful()){\r\n                    DocumentSnapshot document= task.getResult();\r\n                    ArrayList<String> discountUID = (ArrayList) document.get(\"discountUID\");\r\n                    if(discountUID!=null){\r\n                        getMyDiscounts(discountUID);\r\n                    }else  if(discountUID==null){\r\n                        alert.setVisibility(View.VISIBLE);\r\n                        alert.setText(\"Nessuno sconto attivato\");\r\n                    }else if(discountUID.isEmpty()){\r\n                        alert.setVisibility(View.VISIBLE);\r\n                        alert.setText(\"Nessuno sconto attivato\");\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    private void getMyDiscounts(ArrayList discountUID){\r\n        if(!discountUID.isEmpty()){\r\n            Iterator it =discountUID.iterator();\r\n            while(it.hasNext()){\r\n                String uid= (String) it.next();\r\n                myDiscounts.clear();\r\n                db.collection(\"sconti\").document(uid).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {\r\n                    @Override\r\n                    public void onComplete(@NonNull Task<DocumentSnapshot> task) {\r\n                        if(task.isSuccessful()){\r\n                            DocumentSnapshot document= task.getResult();\r\n                            Discount discount=new Discount();\r\n                            discount.setExpiringDate(document.getString(\"expiringDate\"));\r\n                            discount.setBusinessUID(document.getString(\"businessUID\"));\r\n                            discount.setDiscountsQuantity(document.getString(\"discountsQuantity\"));\r\n                            discount.setStartDiscountDate(document.getString(\"startDiscountDate\"));\r\n                            discount.setState(document.getString(\"state\"));\r\n                            discount.setDescription(document.getString(\"description\"));\r\n                            discount.setStepNumber(document.getString(\"stepNumber\"));\r\n                            discount.setBusinessUID(document.getString(\"businessUID\"));\r\n                            myDiscounts.add(discount);\r\n                        }\r\n                    }\r\n                }).addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {\r\n                    @Override\r\n                    public void onComplete(@NonNull Task<DocumentSnapshot> task) {\r\n                        final SellerViewAdapter adapter=new SellerViewAdapter(UserView.this,myDiscounts, userUID,null,\"userHome\");\r\n                        homeListview.setAdapter(adapter);\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    }\r\n    private void getUserPosition() {\r\n        service = (LocationManager) getSystemService(LOCATION_SERVICE);\r\n        locationListener = new LocationListener() {\r\n            @Override\r\n            public void onLocationChanged(@NonNull Location location) {\r\n                latitude=location.getLatitude();\r\n                longitude=location.getLongitude();\r\n                Log.d(\"coordinates\",latitude+\"\\n\"+longitude);\r\n                try {\r\n                    Geocoder geocoder=new Geocoder(UserView.this);\r\n                    List<Address> addresses=new ArrayList<>();\r\n                    addresses=geocoder.getFromLocation(latitude,longitude,1);\r\n                    String country=addresses.get(0).getCountryName();\r\n                    city=addresses.get(0).getLocality();\r\n                    goToUserViewMap();\r\n                    //Log.d(\"city\",city);\r\n                } catch (IOException e) {\r\n                    e.printStackTrace();\r\n                }\r\n            }\r\n\r\n            @Override\r\n            public void onProviderEnabled(@NonNull String provider) {\r\n\r\n            }\r\n\r\n            @Override\r\n            public void onProviderDisabled(@NonNull String provider) {\r\n                new AlertDialog.Builder(UserView.this).setTitle(\"GPS dialog\").setMessage(\"Do you want to turn on gps?\")\r\n                        .setPositiveButton(\"Yes\", new DialogInterface.OnClickListener() {\r\n                            @Override\r\n                            public void onClick(DialogInterface dialogInterface, int i) {\r\n                                Intent intent = new Intent(Settings.ACTION_LOCATION_SOURCE_SETTINGS);\r\n                                startActivity(intent);\r\n                            }\r\n                        }).setNegativeButton(\"Go Back\", null).show();\r\n            }\r\n        };\r\n\r\n    }\r\n\r\n    private void askGPSpermission() {\r\n        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED && ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {\r\n            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {\r\n                requestPermissions(new String[]{Manifest.permission.ACCESS_FINE_LOCATION,Manifest.permission.ACCESS_COARSE_LOCATION,Manifest.permission.INTERNET},10);\r\n            }\r\n            return;\r\n        }\r\n        getUserPosition();\r\n        service.requestLocationUpdates(\"gps\", 500, 1000, locationListener);\r\n    }\r\n\r\n    @Override\r\n    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {\r\n        super.onRequestPermissionsResult(requestCode, permissions, grantResults);\r\n        switch(requestCode){\r\n            case 10:\r\n                if(grantResults.length>0 && grantResults[0]==PackageManager.PERMISSION_GRANTED){\r\n\r\n                }else if(grantResults[0]==PackageManager.PERMISSION_DENIED){\r\n                    if(ActivityCompat.shouldShowRequestPermissionRationale(UserView.this,Manifest.permission.ACCESS_FINE_LOCATION)){\r\n                        //dialog in cui spiego\r\n                        new AlertDialog.Builder(UserView.this)\r\n                                .setTitle(\"Permission\")\r\n                                .setMessage(\"Denying permission you can't use geo-localization\")\r\n                                .setNeutralButton(\"ok\",null)\r\n                                .show();\r\n                    }\r\n                }\r\n                return;\r\n        }\r\n    }\r\n\r\n    private void goToUserViewMap() {\r\n        final Intent intent = new Intent(UserView.this, UserMapView.class);\r\n        intent.putExtra(\"latitude\", latitude);\r\n        intent.putExtra(\"longitude\", longitude);\r\n        intent.putExtra(\"city\", city );\r\n        intent.putExtra(\"UID\", this.userUID);\r\n        startActivity(intent);\r\n\r\n    }\r\n\r\n    public boolean onCreateOptionsMenu(Menu menu){\r\n        getMenuInflater().inflate(R.menu.menu_action_bar, menu);\r\n        return true;\r\n    }\r\n\r\n    public boolean onOptionsItemSelected(MenuItem item){\r\n        return super.onOptionsItemSelected(item);\r\n    }\r\n    private  void startStepCounter(){\r\n        if(userUID!=null  ){\r\n            Intent intent =new Intent(this,StepCounter.class);\r\n            if(isMyServiceRunning(StepCounter.class) == false){\r\n                Toast.makeText(this,\"Contapassi attivato\",Toast.LENGTH_SHORT).show();\r\n                intent.putExtra(\"UID\",userUID);\r\n                startService(intent);\r\n            }else{\r\n                Toast.makeText(this,\"Contapassi disattivato\",Toast.LENGTH_SHORT).show();\r\n                stopService(intent);\r\n            }\r\n        }\r\n    }\r\n    public void OnItemSelected(MenuItem item) {\r\n        switch (item.getItemId()){\r\n            case R.id.stepcounter:\r\n                startStepCounter();\r\n                break;\r\n            case R.id.action_exit:\r\n                logOut();\r\n                break;\r\n            case R.id.action_settings:\r\n                break;\r\n        }\r\n    }\r\n\r\n    private void logOut(){\r\n        FirebaseAuth.getInstance().signOut();\r\n        final Intent intent = new Intent(this, LogIn.class);\r\n        startActivity(intent);\r\n        finish();\r\n    }\r\n    private void createNotificationChannel(){\r\n        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {\r\n            NotificationChannel serviceChannel = new NotificationChannel(\r\n                    CHANNEL_ID,\r\n                    \"StepCounter_notification_channel\",\r\n                    NotificationManager.IMPORTANCE_DEFAULT);\r\n            NotificationManager manager =getSystemService(NotificationManager.class);\r\n            manager.createNotificationChannel(serviceChannel);\r\n        }\r\n    }\r\n\r\n    @Override\r\n    protected void onDestroy() {\r\n        super.onDestroy();\r\n        killServiceIfRunning();\r\n    }\r\n    private void killServiceIfRunning(){\r\n        if(isMyServiceRunning(StepCounter.class) == true){\r\n            Intent intent =new Intent(this,StepCounter.class);\r\n            Toast.makeText(this,\"Contapassi disattivato\",Toast.LENGTH_SHORT).show();\r\n            stopService(intent);\r\n        }\r\n    }\r\n    private boolean isMyServiceRunning(Class<?> serviceClass) {\r\n        ActivityManager manager = (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);\r\n        for (ActivityManager.RunningServiceInfo service : manager.getRunningServices(Integer.MAX_VALUE)) {\r\n            if (serviceClass.getName().equals(service.service.getClassName())) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/java/com/example/walktoshop/User/UserView.java	(revision 61bb8eb5106e6c52282a459695de33c4c7c532c9)
+++ app/src/main/java/com/example/walktoshop/User/UserView.java	(date 1611590052536)
@@ -135,6 +135,7 @@
                         if(task.isSuccessful()){
                             DocumentSnapshot document= task.getResult();
                             Discount discount=new Discount();
+                            discount.setUID(document.getString("uid"));
                             discount.setExpiringDate(document.getString("expiringDate"));
                             discount.setBusinessUID(document.getString("businessUID"));
                             discount.setDiscountsQuantity(document.getString("discountsQuantity"));
Index: app/src/main/java/com/example/walktoshop/User/StepCounter.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.walktoshop.User;\r\n\r\nimport android.app.Notification;\r\nimport android.app.PendingIntent;\r\nimport android.app.Service;\r\nimport android.content.Context;\r\nimport android.content.Intent;\r\nimport android.hardware.Sensor;\r\nimport android.hardware.SensorEvent;\r\nimport android.hardware.SensorEventListener;\r\nimport android.hardware.SensorManager;\r\nimport android.os.Build;\r\nimport android.os.Bundle;\r\nimport android.os.IBinder;\r\nimport android.os.Looper;\r\nimport android.util.Log;\r\nimport android.view.View;\r\nimport android.widget.Button;\r\nimport android.widget.TextView;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.annotation.Nullable;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport androidx.core.app.NotificationCompat;\r\n\r\nimport com.google.android.gms.tasks.OnCompleteListener;\r\nimport com.google.android.gms.tasks.Task;\r\nimport com.google.firebase.firestore.DocumentSnapshot;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.Calendar;\r\nimport java.util.HashMap;\r\n\r\npublic class StepCounter extends Service implements Runnable{\r\n    //definisco manager sensori, counter e detector\r\n    FirebaseFirestore db=FirebaseFirestore.getInstance();\r\n    private String today=null;\r\n    private SensorManager mSensorManager;\r\n    private Sensor mStepCounterSensor;\r\n    private Sensor mStepDetectorSensor;\r\n    private int mySteps=0;\r\n\r\n    private SensorEventListener eventListener;\r\n    private String UID=null;\r\n    private static final String CHANNEL_ID=\"StepCounter_notification_channel\";\r\n    //accelerometer\r\n    private Boolean stepDetectorAbsent=false;\r\n    private double magitudePrevious=0;\r\n    private Sensor accel;\r\n\r\n    @Override\r\n    public void onCreate() {\r\n        super.onCreate();\r\n        mSensorManager = (SensorManager) getSystemService(Context.SENSOR_SERVICE);\r\n        mStepDetectorSensor = mSensorManager.getDefaultSensor(Sensor.TYPE_STEP_DETECTOR);\r\n        Log.d(\"sensor\",\"detector\"+mStepDetectorSensor);\r\n        if(mStepDetectorSensor==null){\r\n\r\n            accel=mSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);\r\n            Log.d(\"sensor\",\"accel\"+accel);\r\n        }\r\n        this.today=getTodayInMills();\r\n        Log.d(\"thread\", String.valueOf(Looper.myLooper() == Looper.getMainLooper()));\r\n        //ottengo riferimento al servizio SENSOR_SERVICE\r\n    }\r\n\r\n    @Override\r\n    public int onStartCommand(Intent intent, int flags, int startId) {\r\n        if(intent.hasExtra(\"UID\")){\r\n            this.UID=intent.getStringExtra(\"UID\");\r\n            //function\r\n\r\n            makeNotificationIntent();\r\n            //crea un thread separato e fa partire il contapassi\r\n            new Thread(this).start();\r\n        }\r\n        return START_NOT_STICKY;\r\n    }\r\n    @Override\r\n    public void run() {\r\n        Log.d(\"started\",\"started\");\r\n        eventListener = new SensorEventListener() {\r\n            @Override\r\n            public void onSensorChanged(SensorEvent event) {\r\n                Sensor sensor = event.sensor;\r\n                float[] values = event.values;\r\n                int value = -1;\r\n\r\n                if (values.length > 0) {\r\n                    value = (int) values[0];\r\n                }\r\n                /*\r\n                if (sensor.getType() == Sensor.TYPE_STEP_COUNTER) {\r\n                    Log.d(\"Step Counter Detected\",\" \"+ value);\r\n                } else*/\r\n                //controllare da che versione c'è il TYPE STEP DETECTOR\r\n\r\n                if (sensor.getType() == Sensor.TYPE_STEP_DETECTOR) {\r\n                    StepCounter.this.mySteps++;\r\n                    Log.d(\"Step Detector\",\" Detector:\" + StepCounter.this.mySteps);\r\n                }else if(mStepDetectorSensor==null){\r\n                    float x=event.values[0];\r\n                    float y=event.values[1];\r\n                    float z=event.values[2];\r\n                    double magnitude = Math.sqrt(x*x+y*y+z*z);\r\n                    double magnitudeDelta=magnitude-magitudePrevious;\r\n                    magitudePrevious=magnitude;\r\n                    if(magnitudeDelta>6){\r\n                        StepCounter.this.mySteps++;\r\n                        Log.d(\"Accel\",\" Accelerometer:\" + StepCounter.this.mySteps);\r\n                    }\r\n                }\r\n            }\r\n\r\n            @Override\r\n            public void onAccuracyChanged(Sensor sensor, int i) {}\r\n        };\r\n        if(mStepDetectorSensor==null){\r\n            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\r\n                mSensorManager.registerListener(eventListener, accel,\r\n                        SensorManager.SENSOR_DELAY_NORMAL);//\r\n            }\r\n        }else{\r\n            mSensorManager.registerListener(eventListener, mStepDetectorSensor, SensorManager.SENSOR_DELAY_FASTEST);\r\n        }\r\n        Log.d(\"thread\", String.valueOf(Looper.myLooper() == Looper.getMainLooper()));\r\n    }\r\n    private void makeNotificationIntent(){\r\n        Intent notificationIntent =new Intent(this,UserView.class);\r\n        PendingIntent pendingIntent=PendingIntent.getActivity(this,0,notificationIntent,0);\r\n        Notification notification =new NotificationCompat.Builder(this,CHANNEL_ID)\r\n                .setContentTitle(\"WalkToShop\")\r\n                .setContentIntent(pendingIntent)\r\n                .build();\r\n        //.setContentText(\"Registrazione in corso\")\r\n        ;//.setSmallIcon(R.id.drawable)\r\n        startForeground(1,notification);\r\n    }\r\n    @Nullable\r\n    @Override\r\n    public IBinder onBind(Intent intent) {\r\n        return null;\r\n    }\r\n\r\n    @Override\r\n    public void onDestroy() {\r\n        super.onDestroy();\r\n        //spegnimento da background service\r\n        Log.d(\"des\",\"destroy\");\r\n        getUserWalkArray();\r\n    }\r\n    private String getTodayInMills(){\r\n        Calendar cal = Calendar.getInstance();\r\n        int year  = cal.get(Calendar.YEAR);\r\n        int month = cal.get(Calendar.MONTH);\r\n        int date  = cal.get(Calendar.DATE);\r\n        cal.clear();\r\n        cal.set(year, month, date);\r\n        long todayMillis2 = cal.getTimeInMillis();\r\n        return String.valueOf(todayMillis2);\r\n    }\r\n    //query\r\n    private void getUserWalkArray(){\r\n        db.collection(\"utente\").document(UID).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {\r\n            @Override\r\n            public void onComplete(@NonNull Task<DocumentSnapshot> task) {\r\n                if(task.isSuccessful()){\r\n                    DocumentSnapshot document=task.getResult();\r\n                    ArrayList<String> walksArray= (ArrayList) document.get(\"walk\");\r\n                    if(walksArray!=null){\r\n                        for(int i=0;i<walksArray.size();i++){\r\n                            Log.d(\"walksArray\",walksArray.get(i));\r\n                        }\r\n                        checkIfNewWalk(walksArray);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    //verifica che quando effettuato l'ultima registrazione e quindi se sovrascrivere le informazioni o aggiungere in un altro oggetto da salvare\r\n    private void checkIfNewWalk(ArrayList<String> walksArray){\r\n        db.collection(\"utente\").document(UID).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {\r\n            @Override\r\n            public void onComplete(@NonNull Task<DocumentSnapshot> task) {\r\n                if(task.isSuccessful()){\r\n                    DocumentSnapshot document= task.getResult();\r\n                    String lastWalkDate=document.getString(\"lastWalkDate\");\r\n                    String todayPlusSteps=today + \",\"+String.valueOf(StepCounter.this.mySteps);\r\n                    if(lastWalkDate!=null){\r\n                        //funzione per l'upload delle camminate\r\n                        long lastWalkDateLong= Long.parseLong(lastWalkDate);\r\n                        long todayLong= Long.parseLong(StepCounter.this.today);\r\n                        Log.d(\"diff\",todayLong + \" \"+lastWalkDateLong);\r\n                        //l'ha fatta oggi?\r\n                        if(lastWalkDateLong>=todayLong){\r\n                            int lastWalkIndex;\r\n                            if(walksArray.size()>0){\r\n                                lastWalkIndex =walksArray.size()-1;\r\n                            }else{\r\n                                lastWalkIndex =0;\r\n                            }\r\n                            Log.d(\"last\", String.valueOf(lastWalkIndex));\r\n                            String oldWalkInfo= walksArray.get(lastWalkIndex);\r\n                            //funzione sconcatena\r\n                            Walk oldWalk=getWalkInfoFromString(oldWalkInfo);\r\n                            String oldSteps=oldWalk.getNumberOfSteps();\r\n                            //Log.d(\"oldsteps\",oldSteps);\r\n                            int updatedSteps=StepCounter.this.mySteps+ Integer.parseInt(oldSteps);\r\n                            Log.d(\"updatedsteps\",updatedSteps+\"\");\r\n                            String todayPlusUpdatedSteps=today + \",\"+updatedSteps;\r\n                            walksArray.set(lastWalkIndex,todayPlusUpdatedSteps);\r\n                        }else{\r\n                            walksArray.add(todayPlusSteps);\r\n                        }\r\n                    }else{\r\n                        Log.d(\"newWalk\",todayPlusSteps);\r\n                        walksArray.add(todayPlusSteps);\r\n                    }\r\n                    updateWalk(walksArray);\r\n                }\r\n            }\r\n        });\r\n    }\r\n    private void updateWalk(ArrayList<String> walksArray){\r\n        for(int i=0;i<walksArray.size();i++){\r\n            Log.d(\"walksarray\",walksArray.get(i));\r\n        }\r\n        db.collection(\"utente\").document(UID).update(\"walk\",walksArray).addOnCompleteListener(new OnCompleteListener<Void>() {\r\n            @Override\r\n            public void onComplete(@NonNull Task<Void> task) {\r\n                setLastWalkDate();\r\n            }\r\n        });\r\n    }\r\n    private void setLastWalkDate(){\r\n        db.collection(\"utente\").document(UID).update(\"lastWalkDate\",today).addOnCompleteListener(new OnCompleteListener<Void>() {\r\n            @Override\r\n            public void onComplete(@NonNull Task<Void> task) {\r\n                //forse qui va lo spegnimento e l'unregistering fare una funzione\r\n                if(eventListener!=null){\r\n                    mSensorManager.unregisterListener(eventListener, mStepCounterSensor);\r\n                    mSensorManager.unregisterListener(eventListener, mStepDetectorSensor);\r\n                }\r\n                new Thread(StepCounter.this).interrupt();\r\n            }\r\n        });\r\n    }\r\n    private Walk getWalkInfoFromString(String info){\r\n        String[] todayAndSteps =info.split(\",\");\r\n        Walk walk =new Walk();\r\n        walk.setDate(todayAndSteps[0]);\r\n        walk.setNumberOfSteps(todayAndSteps[1]);\r\n        return walk;\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/java/com/example/walktoshop/User/StepCounter.java	(revision 61bb8eb5106e6c52282a459695de33c4c7c532c9)
+++ app/src/main/java/com/example/walktoshop/User/StepCounter.java	(date 1611587928138)
@@ -238,9 +238,10 @@
             @Override
             public void onComplete(@NonNull Task<Void> task) {
                 //forse qui va lo spegnimento e l'unregistering fare una funzione
-                if(eventListener!=null){
-                    mSensorManager.unregisterListener(eventListener, mStepCounterSensor);
+                if(eventListener!=null && mStepDetectorSensor!=null){
                     mSensorManager.unregisterListener(eventListener, mStepDetectorSensor);
+                }else if(eventListener!=null && mStepDetectorSensor==null){
+                    mSensorManager.unregisterListener(eventListener, accel);
                 }
                 new Thread(StepCounter.this).interrupt();
             }
Index: app/src/main/res/layout/activity_card_view.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<LinearLayout\r\n    xmlns:android=\"http://schemas.android.com/apk/res/android\"\r\n    xmlns:app=\"http://schemas.android.com/apk/res-auto\"\r\n    xmlns:tools=\"http://schemas.android.com/tools\"\r\n    android:layout_width=\"match_parent\"\r\n    android:layout_height=\"match_parent\"\r\n    android:orientation=\"vertical\">\r\n\r\n    <LinearLayout\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"?attr/actionBarSize\"\r\n        android:orientation=\"horizontal\"\r\n        android:background=\"@color/verde_maggio\"\r\n        android:visibility=\"gone\">\r\n        <com.google.android.material.floatingactionbutton.FloatingActionButton\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_gravity=\"center\"\r\n            android:layout_marginLeft=\"15dp\"\r\n            app:fabSize=\"mini\"/>\r\n        <androidx.appcompat.widget.AppCompatTextView\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:layout_gravity=\"center\"\r\n            android:layout_marginLeft=\"30dp\"\r\n            android:textColor=\"@color/white\"\r\n            android:text=\"Sconto del 20%\"\r\n            android:textSize=\"30dp\"/>\r\n\r\n    </LinearLayout>\r\n\r\n    <com.google.android.material.card.MaterialCardView\r\n        android:id=\"@+id/card\"\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"match_parent\"\r\n        android:layout_margin=\"8dp\"\r\n        android:orientation=\"vertical\">\r\n\r\n        <ImageButton\r\n            style=\"?attr/borderlessButtonStyle\"\r\n            android:layout_width=\"wrap_content\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:src=\"@drawable/ic_condividi\"\r\n            android:layout_gravity=\"top|right\"/>\r\n\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"vertical\">\r\n\r\n            <!-- Media -->\r\n\r\n            <androidx.constraintlayout.widget.ConstraintLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"match_parent\">\r\n\r\n                <ProgressBar\r\n                    android:id=\"@+id/progerssBar\"\r\n                    style=\"@style/CircularDeterminateprogressBar\"\r\n                    android:layout_width=\"match_parent\"\r\n                    android:layout_height=\"350dp\"\r\n                    android:layout_gravity=\"center\"\r\n                    android:layout_marginEnd=\"16dp\"\r\n                    android:layout_marginBottom=\"16dp\"\r\n                    app:layout_constraintBottom_toBottomOf=\"parent\"\r\n                    app:layout_constraintEnd_toEndOf=\"parent\"\r\n                    tools:ignore=\"MissingConstraints\"\r\n                    tools:progress=\"0\" />\r\n\r\n                <ImageView\r\n                    android:layout_width=\"121dp\"\r\n                    android:layout_height=\"113dp\"\r\n                    android:src=\"@drawable/icons8_esercizio_96\"\r\n                    app:layout_constraintBottom_toBottomOf=\"@+id/progerssBar\"\r\n                    app:layout_constraintEnd_toEndOf=\"@+id/progerssBar\"\r\n                    app:layout_constraintStart_toStartOf=\"@+id/progerssBar\"\r\n                    app:layout_constraintTop_toTopOf=\"@+id/progerssBar\" />\r\n\r\n            </androidx.constraintlayout.widget.ConstraintLayout>\r\n\r\n            <LinearLayout\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_gravity=\"center\"\r\n                android:orientation=\"vertical\">\r\n                <TextView\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"2000/5000\"\r\n                    android:textSize=\"30dp\"\r\n                    android:textColor=\"@color/black\"/>\r\n                <TextView\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:layout_marginLeft=\"15dp\"\r\n                    android:layout_marginTop=\"10dp\"\r\n                    android:text=\"30 Kcal\"\r\n                    android:textSize=\"30dp\"\r\n                    android:textColor=\"@color/black\"/>\r\n                <TextView\r\n                    android:layout_marginTop=\"10dp\"\r\n                    android:layout_marginLeft=\"20dp\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:text=\"50 km\"\r\n                    android:textSize=\"30dp\"\r\n                    android:textColor=\"@color/black\"/>\r\n            </LinearLayout>\r\n\r\n            <LinearLayout\r\n                android:layout_width=\"match_parent\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:background=\"#f8f8ff\"\r\n                android:orientation=\"vertical\"\r\n                android:padding=\"16dp\">\r\n\r\n                <TextView\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:layout_marginTop=\"16dp\"\r\n                    android:text=\"Lo sconto è applicabile solo a determinate tipologie di sconti o applicazioni usarlo con prudenza.\"\r\n                    android:textAppearance=\"?attr/textAppearanceBody2\"\r\n                    android:textColor=\"?android:attr/textColorSecondary\" />\r\n\r\n            </LinearLayout>\r\n\r\n            <LinearLayout\r\n                android:id=\"@+id/linearCard1\"\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\"\r\n                android:layout_gravity=\"center\">\r\n\r\n            </LinearLayout>\r\n\r\n\r\n        </LinearLayout>\r\n\r\n    </com.google.android.material.card.MaterialCardView>\r\n</LinearLayout>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/res/layout/activity_card_view.xml	(revision 61bb8eb5106e6c52282a459695de33c4c7c532c9)
+++ app/src/main/res/layout/activity_card_view.xml	(date 1611589758292)
@@ -85,12 +85,14 @@
                 android:layout_gravity="center"
                 android:orientation="vertical">
                 <TextView
+                    android:id="@+id/goalStepsRatio"
                     android:layout_width="wrap_content"
                     android:layout_height="wrap_content"
                     android:text="2000/5000"
                     android:textSize="30dp"
                     android:textColor="@color/black"/>
                 <TextView
+                    android:id="@+id/kcal"
                     android:layout_width="wrap_content"
                     android:layout_height="wrap_content"
                     android:layout_marginLeft="15dp"
@@ -99,6 +101,7 @@
                     android:textSize="30dp"
                     android:textColor="@color/black"/>
                 <TextView
+                    android:id="@+id/kilometers"
                     android:layout_marginTop="10dp"
                     android:layout_marginLeft="20dp"
                     android:layout_width="wrap_content"
@@ -116,6 +119,7 @@
                 android:padding="16dp">
 
                 <TextView
+                    android:id="@+id/code"
                     android:layout_width="wrap_content"
                     android:layout_height="wrap_content"
                     android:layout_marginTop="16dp"
Index: app/src/main/res/layout/activity_sellerviewadapter.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<LinearLayout\r\n    xmlns:android=\"http://schemas.android.com/apk/res/android\" android:layout_width=\"match_parent\"\r\n    android:layout_height=\"wrap_content\"\r\n    android:orientation=\"vertical\">\r\n\r\n    <androidx.cardview.widget.CardView\r\n        android:layout_width=\"match_parent\"\r\n        android:layout_height=\"wrap_content\">\r\n        <LinearLayout\r\n            android:layout_width=\"match_parent\"\r\n            android:layout_height=\"wrap_content\"\r\n            android:orientation=\"vertical\">\r\n\r\n            <LinearLayout\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:orientation=\"horizontal\">\r\n\r\n                <ImageView\r\n                    android:id=\"@+id/imageView\"\r\n                    android:layout_width=\"150dp\"\r\n                    android:layout_height=\"150dp\"\r\n                    android:src=\"@drawable/addimage\">\r\n                </ImageView>\r\n\r\n                <LinearLayout\r\n                    android:layout_width=\"230dp\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:orientation=\"vertical\"\r\n                    android:layout_gravity=\"center\">\r\n                    <LinearLayout\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:orientation=\"horizontal\">\r\n                        <TextView\r\n                            android:id=\"@+id/difficulty\"\r\n                            android:layout_width=\"wrap_content\"\r\n                            android:layout_height=\"wrap_content\"\r\n                            android:textSize=\"20dp\"\r\n                            android:layout_marginVertical=\"8dp\"\r\n                            android:textColor=\"@color/black\"\r\n                            android:text=\"Easy Difficult\" />\r\n\r\n                        <ImageView\r\n                            android:id=\"@+id/difficultyColor\"\r\n                            android:layout_width=\"24dp\"\r\n                            android:layout_height=\"26dp\"\r\n                            android:layout_marginTop=\"1dp\"\r\n                            android:layout_gravity=\"center\"\r\n                            android:src=\"@drawable/ic_green\" />\r\n                    </LinearLayout>\r\n\r\n                    <TextView\r\n                        android:id=\"@+id/disocuntDescription\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:textColor=\"@color/black\"\r\n                        android:textSize=\"17dp\"\r\n                        android:text=\"questa è una entuale descrizione da inserire all'interno dello sconto\">\r\n                    </TextView>\r\n\r\n                </LinearLayout>\r\n                <LinearLayout\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:layout_gravity=\"center\">\r\n                    <ImageButton\r\n                        android:id=\"@+id/arrow\"\r\n                        android:background=\"@color/white\"\r\n                        android:layout_width=\"wrap_content\"\r\n                        android:layout_height=\"wrap_content\"\r\n                        android:src=\"@drawable/ic_freccia1\">\r\n\r\n                    </ImageButton>\r\n                </LinearLayout>\r\n            </LinearLayout>\r\n            <LinearLayout\r\n                android:layout_width=\"wrap_content\"\r\n                android:layout_height=\"wrap_content\"\r\n                android:layout_gravity=\"bottom\">\r\n\r\n                <TextView\r\n                    android:id=\"@+id/date\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:layout_gravity=\"center\"\r\n                    android:layout_marginLeft=\"20dp\"\r\n                    android:layout_marginRight=\"180dp\"\r\n                    android:text=\"27/01/2021\"\r\n                    android:textColor=\"@color/black\">\r\n\r\n                </TextView>\r\n\r\n                <Button\r\n                    android:id=\"@+id/addButton\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:background=\"@drawable/ovale\"\r\n                    android:visibility=\"visible\"\r\n                    android:textColor=\"@color/white\"\r\n                    android:text=\"AGGIUNGI\">\r\n                </Button>\r\n\r\n                <ImageButton\r\n                    android:id=\"@+id/editDiscount\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:background=\"@color/white\"\r\n                    android:layout_marginRight=\"20dp\"\r\n                    android:src=\"@android:drawable/ic_menu_edit\"\r\n                    android:tint=\"@color/verde_maggio\"\r\n                    android:visibility=\"gone\"/>\r\n                <ImageButton\r\n                    android:id=\"@+id/deleteDiscount\"\r\n                    android:layout_width=\"wrap_content\"\r\n                    android:background=\"@color/white\"\r\n                    android:layout_height=\"wrap_content\"\r\n                    android:layout_marginRight=\"20dp\"\r\n                    android:src=\"@android:drawable/ic_menu_delete\"\r\n                    android:tint=\"@color/verde_maggio\"\r\n                    android:visibility=\"gone\"/>\r\n\r\n            </LinearLayout>\r\n\r\n        </LinearLayout>\r\n\r\n    </androidx.cardview.widget.CardView>\r\n\r\n</LinearLayout>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/res/layout/activity_sellerviewadapter.xml	(revision 61bb8eb5106e6c52282a459695de33c4c7c532c9)
+++ app/src/main/res/layout/activity_sellerviewadapter.xml	(date 1611589199146)
@@ -25,7 +25,7 @@
                 </ImageView>
 
                 <LinearLayout
-                    android:layout_width="230dp"
+                    android:layout_width="210dp"
                     android:layout_height="wrap_content"
                     android:orientation="vertical"
                     android:layout_gravity="center">
Index: app/src/main/java/com/example/walktoshop/User/CardView.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.example.walktoshop.User;\r\n\r\nimport android.app.ActivityManager;\r\nimport android.content.Context;\r\nimport android.content.Intent;\r\nimport android.os.Bundle;\r\nimport android.util.Log;\r\nimport android.view.MenuItem;\r\nimport android.view.View;\r\nimport android.widget.Button;\r\nimport android.widget.ProgressBar;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.annotation.Nullable;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\n\r\nimport com.example.walktoshop.R;\r\nimport com.example.walktoshop.Seller.Discount;\r\nimport com.google.android.gms.tasks.OnCompleteListener;\r\nimport com.google.android.gms.tasks.Task;\r\nimport com.google.firebase.firestore.DocumentSnapshot;\r\nimport com.google.firebase.firestore.FirebaseFirestore;\r\nimport com.google.gson.Gson;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.Iterator;\r\n\r\npublic class CardView extends AppCompatActivity {\r\n    private ProgressBar progressBar;\r\n    private Discount d;\r\n    private String UID=null;\r\n    private long totalSteps=0;\r\n    private int kilometers;\r\n    private int kcal;\r\n    int percentage=0;\r\n    FirebaseFirestore db=FirebaseFirestore.getInstance();\r\n\r\n\r\n    @Override\r\n    protected void onCreate(@Nullable Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        setContentView(R.layout.activity_card_view);\r\n        getSupportActionBar().setDisplayHomeAsUpEnabled(true);\r\n        getSupportActionBar().setHomeButtonEnabled(true);\r\n        progressBar = (ProgressBar) findViewById(R.id.progerssBar);\r\n        //progressBar.setProgress(70);\r\n        Intent intent=getIntent();\r\n        if(intent.hasExtra(\"discount\") && intent.hasExtra(\"UID\")){\r\n            Log.d(\"s\",\"ecco\");\r\n            Gson gson = new Gson();\r\n            String jsonDiscount=intent.getStringExtra(\"discount\");\r\n            this.d= gson.fromJson(jsonDiscount, Discount.class);\r\n            this.UID = intent.getStringExtra(\"UID\");\r\n        }\r\n\r\n\r\n    }\r\n\r\n    @Override\r\n    protected void onStart() {\r\n        super.onStart();\r\n        long goal= Long.parseLong(d.getDiscountsQuantity());\r\n        long beginDiscountDate= Long.parseLong(d.getStartDiscountDate());\r\n        long expiringDiscountDate= Long.parseLong(d.getExpiringDate());\r\n        getUserWalkInATimeRange(beginDiscountDate,expiringDiscountDate,goal);\r\n    }\r\n\r\n    @Override\r\n    public boolean onOptionsItemSelected(@NonNull MenuItem item) {\r\n        if(item.getItemId() == android.R.id.home){\r\n            finish();\r\n        }\r\n        return super.onOptionsItemSelected(item);\r\n    }\r\n    private void getUserWalkInATimeRange(long beginDiscountDate,long expiringDiscountDate,long goal){\r\n        db.collection(\"utente\").document(UID).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {\r\n            @Override\r\n            public void onComplete(@NonNull Task<DocumentSnapshot> task) {\r\n                if(task.isSuccessful()){\r\n                    DocumentSnapshot document=task.getResult();\r\n                    ArrayList<String> myStringedWalks= (ArrayList<String>) document.get(\"walk\");\r\n                    //Log.d(\"size\",myStringedWalks.size()+\"\");\r\n                    if(myStringedWalks==null){\r\n                        myStringedWalks=new ArrayList<>();\r\n                    }\r\n                    Iterator it=myStringedWalks.iterator();\r\n                    while(it.hasNext()){\r\n                        String dateAndSteps= (String) it.next();\r\n                        Walk walk=getWalkInfoFromString(dateAndSteps);\r\n                        long date= Long.parseLong(walk.getDate());\r\n                        Log.d(\"date\", String.valueOf(date >= beginDiscountDate));\r\n                        Log.d(\"date\", String.valueOf(date <= expiringDiscountDate));\r\n                        if(date>=beginDiscountDate && date<=expiringDiscountDate){\r\n                            long walkSteps= Long.parseLong(walk.getNumberOfSteps());\r\n                            totalSteps=totalSteps + walkSteps;\r\n                            //dailykcal\r\n                            //dailykm\r\n                        }\r\n                    }\r\n                    if(totalSteps!=0 && goal!=0){\r\n                        percentage=Math.round((float)(totalSteps*100)/goal) ;\r\n                        //Log.d(\"percentage\", percentage+\"\");\r\n                        progressBar.setProgress((int)percentage);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    @Override\r\n    protected void onDestroy() {\r\n        super.onDestroy();\r\n        killServiceIfRunning();\r\n    }\r\n    private void killServiceIfRunning(){\r\n        if(isMyServiceRunning(StepCounter.class) == true){\r\n            Intent intent =new Intent(this,StepCounter.class);\r\n            Toast.makeText(this,\"Contapassi disattivato\",Toast.LENGTH_SHORT).show();\r\n            stopService(intent);\r\n        }\r\n    }\r\n    private boolean isMyServiceRunning(Class<?> serviceClass) {\r\n        ActivityManager manager = (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);\r\n        for (ActivityManager.RunningServiceInfo service : manager.getRunningServices(Integer.MAX_VALUE)) {\r\n            if (serviceClass.getName().equals(service.service.getClassName())) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n    private Walk getWalkInfoFromString(String info){\r\n        String[] todayAndSteps =info.split(\",\");\r\n        Walk walk =new Walk();\r\n        walk.setDate(todayAndSteps[0]);\r\n        walk.setNumberOfSteps(todayAndSteps[1]);\r\n        return walk;\r\n    }\r\n\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/java/com/example/walktoshop/User/CardView.java	(revision 61bb8eb5106e6c52282a459695de33c4c7c532c9)
+++ app/src/main/java/com/example/walktoshop/User/CardView.java	(date 1611590122505)
@@ -9,6 +9,7 @@
 import android.view.View;
 import android.widget.Button;
 import android.widget.ProgressBar;
+import android.widget.TextView;
 import android.widget.Toast;
 
 import androidx.annotation.NonNull;
@@ -31,8 +32,12 @@
     private Discount d;
     private String UID=null;
     private long totalSteps=0;
-    private int kilometers;
-    private int kcal;
+    private TextView goalStepRatio;
+    private TextView kcal;
+    private TextView kilometers;
+    private TextView code;
+    private String userWeight=null;
+    private String userHeight=null;
     int percentage=0;
     FirebaseFirestore db=FirebaseFirestore.getInstance();
 
@@ -44,13 +49,18 @@
         getSupportActionBar().setDisplayHomeAsUpEnabled(true);
         getSupportActionBar().setHomeButtonEnabled(true);
         progressBar = (ProgressBar) findViewById(R.id.progerssBar);
-        //progressBar.setProgress(70);
+        goalStepRatio= findViewById(R.id.goalStepsRatio);
+        kcal=findViewById(R.id.kcal);
+        code=findViewById(R.id.code);
+        kilometers = findViewById(R.id.kilometers);
+
         Intent intent=getIntent();
         if(intent.hasExtra("discount") && intent.hasExtra("UID")){
-            Log.d("s","ecco");
             Gson gson = new Gson();
             String jsonDiscount=intent.getStringExtra("discount");
-            this.d= gson.fromJson(jsonDiscount, Discount.class);
+            Log.d("d",jsonDiscount);
+            this.d = gson.fromJson(jsonDiscount, Discount.class);
+
             this.UID = intent.getStringExtra("UID");
         }
 
@@ -63,6 +73,7 @@
         long goal= Long.parseLong(d.getDiscountsQuantity());
         long beginDiscountDate= Long.parseLong(d.getStartDiscountDate());
         long expiringDiscountDate= Long.parseLong(d.getExpiringDate());
+        getUserInfo();
         getUserWalkInATimeRange(beginDiscountDate,expiringDiscountDate,goal);
     }
 
@@ -73,6 +84,18 @@
         }
         return super.onOptionsItemSelected(item);
     }
+    private void getUserInfo(){
+        db.collection("utente").document(UID).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {
+            @Override
+            public void onComplete(@NonNull Task<DocumentSnapshot> task) {
+                if(task.isSuccessful()){
+                    DocumentSnapshot document= task.getResult();
+                    CardView.this.userWeight=document.getString("weight");
+                    CardView.this.userHeight=document.getString("height");
+                }
+            }
+        });
+    }
     private void getUserWalkInATimeRange(long beginDiscountDate,long expiringDiscountDate,long goal){
         db.collection("utente").document(UID).get().addOnCompleteListener(new OnCompleteListener<DocumentSnapshot>() {
             @Override
@@ -99,9 +122,16 @@
                         }
                     }
                     if(totalSteps!=0 && goal!=0){
-                        percentage=Math.round((float)(totalSteps*100)/goal) ;
-                        //Log.d("percentage", percentage+"");
+                        percentage=Math.round((float)(totalSteps*100)/goal);
+                        if(percentage>=100){
+                            code.setText("Ecco il tuo codice sconto: "+UID+d.getUID());
+                        }
                         progressBar.setProgress((int)percentage);
+                        goalStepRatio.setText(totalSteps+"/"+goal);
+                        float km=calculateKilometers(Integer.parseInt(CardView.this.userHeight),totalSteps);
+                        kilometers.setText(km+" Km");
+                        int calories=calculateKcal(Integer.parseInt(CardView.this.userWeight),totalSteps);
+                        kcal.setText(calories+" Kcal");
                     }
                 }
             }
@@ -136,5 +166,23 @@
         walk.setNumberOfSteps(todayAndSteps[1]);
         return walk;
     }
+    private float calculateKilometers(int height,long steps){
+        float meters;
+        if(height<170){
+            meters=Math.round((float)600*steps/1000);
+        }else{
+            meters=Math.round((float)700*steps/1000);
+        }
+        float kilometers=meters/1000;
+        Log.d("km",kilometers+"");
+        return kilometers;
+    }
+    private int calculateKcal(int weight,long steps){
+        int kcal;
+        Log.d("weight",weight+"");
+        kcal= (int) Math.round((float)weight*0.0005*steps);
+        Log.d("kcal",kcal+"");
+        return kcal;
+    }
 
 }
Index: .idea/gradle.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"GradleSettings\">\r\n    <option name=\"linkedExternalProjectsSettings\">\r\n      <GradleProjectSettings>\r\n        <option name=\"testRunner\" value=\"PLATFORM\" />\r\n        <option name=\"distributionType\" value=\"DEFAULT_WRAPPED\" />\r\n        <option name=\"externalProjectPath\" value=\"$PROJECT_DIR$\" />\r\n        <option name=\"gradleJvm\" value=\"1.8\" />\r\n        <option name=\"modules\">\r\n          <set>\r\n            <option value=\"$PROJECT_DIR$\" />\r\n            <option value=\"$PROJECT_DIR$/app\" />\r\n          </set>\r\n        </option>\r\n        <option name=\"resolveModulePerSourceSet\" value=\"false\" />\r\n        <option name=\"useQualifiedModuleNames\" value=\"true\" />\r\n      </GradleProjectSettings>\r\n    </option>\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- .idea/gradle.xml	(revision 61bb8eb5106e6c52282a459695de33c4c7c532c9)
+++ .idea/gradle.xml	(date 1611587393241)
@@ -1,5 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <project version="4">
+  <component name="GradleMigrationSettings" migrationVersion="1" />
   <component name="GradleSettings">
     <option name="linkedExternalProjectsSettings">
       <GradleProjectSettings>
